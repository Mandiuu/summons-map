<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="How the NYC Police Enforcement Intensified">
    <meta property="og:description" content="A visualization of the summonses in NYC since 2018">
    <meta property="og:type" content="article">
    <meta property="og:image" content="PXL.jpg">
  
    <title>Look at NYC Summons</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Shrikhand&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900&family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&family=Teachers:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <link rel="icon" href="magnifying-glass.png">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            line-height: 1.4;
            overflow: auto;
            background-color: #F7F9F9;
            color: #5d001E;
        }

        body {
            background-color: #F7F9F9;
            color: black;
            margin: 0;
            font-size: 12px;
            font-family: "Newsreader", 'Times New Roman', Times, serif;
            text-rendering: optimizeLegibility;
        }

        .content {
            max-width: 700px;
            margin: auto;
            font-size: 16px;
        }

        .content p,
        .content .byline p,
        .content a {
            font-size: 25px;
            line-height: 1.6;
            margin: 0;
            padding-bottom: 1.2em;
        }

        .header.with-image-bg {
            padding: 50px 20px;
            background-color: #333;
            color: white;
            text-align: center;
            background-image: url('PXL.jpg');
            background-size: cover;
            background-position: center;
            height: 640px;
        }

        .header.with-image-bg .title {
            font-size: 9em;
            margin-top: 1em;
            margin-bottom: 0;
            font-family: "Newsreader", system-ui;
            text-shadow: 2px 2px 4px #000, -2px -2px 4px #000;
        }

        .header.with-image-bg .subtitle {
            font-size: 5em;
            margin-top: 1.4em;
            color: white;
            font-family: "Newsreader", system-ui;
            text-shadow: 2px 2px 4px #000, -2px -2px 4px #000;
        }

        #map-container {
            height: 95vh; /* Increased height */
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #sidebar {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 350px; /* Increased width */
            font-family: 'Montserrat', sans-serif;
            background: #333;
            color: white;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 1;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            max-height: 120vh;
        }

        .sidebar-visible {
            display: flex !important;
        }

        #categoryList {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            overflow-y: hidden;
        }

        .category-box {
            width: calc(40% - 10px);
            height: 90px; /* Increased height */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px;
            color: white;
            text-align: center;
            border: none;
            cursor: pointer;
            flex-direction: column;
            box-sizing: border-box;
            font-size: 12px; /* Increased font size */
            position: relative;
        }

        .category-box span:first-child {
            font-weight: bold;
            font-size: 13px; /* Increased font size */
            margin-bottom: auto;
            white-space: normal;
            word-break: break-word;
            text-align: center;
        }

        .category-box span:nth-child(2) {
            font-weight: bold;
            font-size: 26px; /* Increased font size */
            margin-top: -2px;
        }

        .category-count {
            font-weight: bold;
            font-size: 20px; /* Increased font size */
            margin-bottom: auto;
        }

        .triangle-up {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid red;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        .triangle-down {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid green;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Lato', Arial, Helvetica, sans-serif;
        }

        #yearSlider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.9;
            margin: 20px 0;
            position: relative;
        }

        #yearSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearLabel {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            margin-top: 10px;
        }

        .sidebar-footer {
            font-size: 12px;
            color: white;
            text-align: right;
        }

        .sidebar-header {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 0px;
        }

        .sidebar-header2 {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 30px;
        }

        .mapboxgl-ctrl-group {
        font-size: 14px; /* Adjust the font size */
    }

        .mapboxgl-ctrl-geocoder--input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Lato', sans-serif;
            box-sizing: border-box;
        }

        .mapboxgl-ctrl-geocoder--icon-search {
            width: 15px;
            height: 15px;
            left: 1px;
            margin-left: 10px;
        }

        .mapboxgl-ctrl-geocoder--input::placeholder {
            padding-left: 25px;
        }

        .header, .footer {
            text-align: center;
            padding: 10px 0;
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
            font-family: 'Teachers', sans-serif;
        }

        .header h2 {
            margin: 0;
            font-size: 1.2em;
            color: gray;
        }

        .byline {
            margin: 20px 0;
            text-align: center;
        }
        .content .byline p {
    font-style: normal; /* Ensure the text is not italic */
}

        .footer {
            margin-top: 50px;
            font-size: 0.1em;
            color: gray;
        }

        .source-footer {
            font-size: 0.2em;
            text-align: center;
        }

        .average-label {
            font-size: 10px;
            color: white;
            position: absolute;
            bottom: 5px;
            left: 30px;
        }

        #header p {
            font-size: 18px;
            font-family: "Montserrat", 'Times New Roman', Times, serif;
        }

        @media (max-width: 768px) {
            #map-container {
                height: 60vh; /* Reduce map height on mobile */
            }

            #sidebar {
                position: absolute;
    top: 0;
    bottom: 0;
    width: 350px;
    font-family: 'Montserrat', sans-serif;
    background: #333;
    color: white;
    padding: 10px;
    overflow-y: hidden; /* Hide overflow to prevent scrollbar */
    flex-shrink: 0;
    z-index: 1;
    display: none;
    flex-direction: column;
    justify-content: space-between;
    height: 90vh; 
            }

            .category-box {
                font-size: 12px;
                width: 100%;
                height: auto;
            }

            #yearLabel, .sidebar-header, .sidebar-header2 {
                font-size: 14px;
            }

            .sidebar-footer {
                font-size: 10px;
            }

            .mapboxgl-popup {
                font-size: 10px;
            }

            #map {
                width: 100%;
                height: 300px;
            }

            .header.with-image-bg {
                padding: 20px;
                text-align: center;
            }

            .header.with-image-bg .title {
                font-size: 3em;
                margin-top: 0.5em;
                margin-bottom: 0;
            }

            .header.with-image-bg .subtitle {
                font-size: 2em;
                margin-top: 0.5em;
                color: white;
                font-weight: bold;
            }

            .content {
                padding: 10px;
                font-size: 14px;
            }

            .content p, .content .byline p, .content a {
                font-size: 18px;
            }

            #story {
                width: 100%;
                height: auto;
                position: static;
                display: flex;
                flex-direction: column;
            }

            #toggleStoryButton {
                display: block;
                position: static;
                width: 100%;
                padding: 8px 16px; 
                font-size: 14px;
            }
        }

        .dark {
            background: none;
            padding: 10px;
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .dark h1 {
            font-family: 'Montserrat', sans-serif;
        }

        .dark h2 {
            font-family: 'Montserrat', sans-serif;
        }

        #story {
            width: 350px; 
            overflow-y: auto;
            z-index: 2;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0; 
            background: none;
            color: white; /* Match the text color of the left sidebar */
            padding: 10px; /* Match the padding of the left sidebar */
            display: none; /* Hide by default */
            flex-direction: column;
            justify-content: space-between;
            height: 100%; /* Ensure it matches the height of the map */
            box-sizing: border-box;
        }

        .step {
            margin-bottom: 200px;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .step.active {
            opacity: 1;
        }

        .step h3 {
            margin: 0;
            padding: 0;
            font-size: 2em;
            font-family: 'Montserrat', sans-serif;
            color: #333;
        }

        .step p {
            margin: 10px 0 0;
            padding: 0;
            font-size: 1.5em;
            font-family: 'Montserrat', sans-serif;
            color: #666;
        }

        .chapter-box {
            padding: 20px;
            margin: 20px auto; /* Center align by default */
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 9px;
            max-width: 800px; 
        }

        #header, #footer {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: 'Montserrat', sans-serif;
            max-width: 700px;
        }

        #toggleStoryButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 3;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3FB1CE;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; 
        }

        #features {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .chapter-box {
            margin: 50px 0;
        }

        .step {
            margin-bottom: 200px;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .step.active {
            opacity: 1;
        }

        .image-container {
            width: 100vw; /* Full viewport width */
    margin-left: calc(-50vw + 50%); /* Offset the margin to ensure full width */
    margin-right: calc(-50vw + 50%); /* Offset the margin to ensure full width */
    overflow: hidden; /* Ensure content does not overflow */
}

.image-container img {
    width: 100%; /* Scale the image to the width of its container */
    height: auto; /* Maintain aspect ratio */

}

figcaption {
    text-align: right; 
    font-size: 0.9em; 
    color: #666; 
    margin-top: 8px; 
    padding-right: 20px; 
    box-sizing: border-box; 
}
    </style>
</head>

<body>
    <div class="header with-image-bg">
        <h1 class="title"><span>Yelling, Cursing, Drinking:</span></h1>
        <h2 class="subtitle">How the NYC Police Enforcement Intensified</h2>
    </div>

    <div class="content">
        <div class="byline">
            <p>By Carla Mandiola</p>
        </div>
        <p>
            The yelling, cursing, and drinking confront Jessica Williams night after night.
        </p>
        <p>
            As she approaches the edge of popular Washington Square Park in Manhattan's Greenwich Village neighborhood, Williams says 
            she has to decide whether to walk around or get through it on the way to her apartment.         </p>
        <p>
            The park, for her, remains a colorful, fascinating, and often welcoming place to have close by. But the nightly nuisances, 
            she says, are getting on her nerves.
        </p>
        <p>
            "It may be nice for the tourists, but for me, it's impossible to cross this park at night, so to get to my place, I need to
             wander around other streets," says Williams, a chiropractor who has lived for ten years on the north side block of the 
             four-square-block park, famous for its Romanesque stone arch. "I feel like it's getting worse with time."        </p>
      
             <p>     Williams faces issues police see in Washington Square Park and the entire city.        </p>
        <p> Since 2021, the number of summonses police have issued for quality-of-life offenses like public drinking, drug use, noise, or street vending without a license has more than doubled, with roughly 107,000 tickets handed out last year, according to an analysis of New York Police Department crime data by the Columbia Journalism School. 
        </p>

        <p>From the popular bustle of the park to the street corners of Sheepshead Bay in Brooklyn, the touristy neighborhoods of Manhattan, and the northern stretches of the Bronx, the analysis found that the tally from 2023 marked the highest point since 2017.
        </p>
        <p> The heightened attention, which harkens back to the days of 'broken windows' policing to fight a crime wave in the 1990s, has been far from uniform. The biggest spikes in summonses have come in select areas of Manhattan that are popular among tourists, as well as swaths of southern Brooklyn and northern and central Queens. </p> 
        <p>The annual count rose more than tenfold in those areas from 2021 to 2023, and at the same time, other neighborhoods showed only minimal changes.
        </p>
        <p>While fighting minor crimes in a city of 8 million, where 29,000 people live per square mile, can be like chasing marbles rolling around a vast floor, the strategy can afford crime-wary residents a sense that police are addressing day-to-day concerns that pose anything from minor annoyances to major headaches.
        </p>
        <p>It reflects, experts say, a strategy similar to the approach employed in the 1990s when the city attempted to address a wave of violent crime by arresting people for minor offenses who would then turn out to be suspects in major crimes.
        </p>
        
        <p>The key drivers of the trend are public drinking and drug use, which is up 39 percent, and disorderly behavior, which is up 94 percent. Greenwich Village, where Jessica lives, is part of police Precinct 6, which has seen one of the most significant spikes in the last two years: from 38 non-vehicle-related summonses to 407 in 2023. That's a 971 percent increase in tickets issued in the Washington Square Park, Christopher Street, and Broadway areas. 
        </p>
        <p>"I'm telling you, it's getting more and more complicated to live here with all the crazy people around the park and the streets," says Jessica. "But I don't know what the solution is if giving people more summons still makes it feel dangerous to walk at night."
        </p>
        <p>Along with Greenwich Village, tourist spots like Times Square, the Empire State Building, and Rockefeller Center saw some of the most significant increases from 2021 to 2023. Other neighborhoods seeing big spikes included University Heights in the Bronx and East Harlem in Manhattan. 
        </p>
        <div class="image-container">
            <img src="building.jpg" alt="Building with a sign in Harlem, with reasons you could get a summons." class="large-image">
            <figcaption>Photo credit: Carla Mandiola</figcaption>

        </div>
        <p>The increase comes when overall crime has been flat, with major offenses down slightly, by less than 1 percent, from 2022 to 2023. Decreases have led to a downward trend in murders, shootings, sexual assaults, burglaries, grand larcenies, and robberies, while the number of car thefts and felony assaults increased. 
        </p>
        <p>When Mayor Eric Adams announced the 2023 citywide crime statistics, he said, "New York City remains the safest big city in America. These numbers tell us that we are turning the corner on crime in the city."
        </p>
        <p>Multiple attempts to obtain a comment from the NYPD Deputy Commissioner of Public Information were unsuccessful. However, according to experts, the increase in summonses, along with more police officers in subways and neighborhoods, is only sometimes related to a sense of security. 
        </p>
        <p>Anna Stenkamp, Senior Research Associate at the Data Collaborative for Justice, explained that "once the Adams administration took office and appointed a new police commissioner, the focus shifted to low-level enforcement. The belief was that targeting minor offenses would lead to a reduction in more serious crimes. While they avoided using the term 'broken windows policing,' the approach was very similar, despite limited evidence supporting its effectiveness in reducing major crimes."
        </p>
        <p>Edwin Grimsley, a professor at CUNY and co-author of a report about the Impact of New York City's Criminal Justice Reform Act: Summons Issuance and Outcomes, explains the effect of police presence and summonses. "The data and literature do not strongly support the idea that a greater police presence improves safety. People often feel less safe despite the increased policing."
        </p>
        <p>John Eterno, a former New York City police captain and professor of criminal justice at Molloy College, said the summons trend showed a renewed police focus on minor crimes.
        </p>
        <p>"Over time, many policies shifted with changes like bail reform and equity considerations for the poor. For example, they stopped penalizing those who jumped turnstiles, essentially allowing free rides," says John Eterno. "Much of this depends on the police department's policies, which the Mayor often directs. The Mayor's priorities significantly impact summons activity."</p>
<p>While the summons counts have risen, New Yorkers en masse are taking little notice - at least not yet.</p>
<p>From her perspective in the Bronx, Ursula Greene says she sees the problems in the neighborhoods continuing even more than ever. After living for 30 years in the northeast section of the Bronx, she said she felt more insecure than before. 
</p>
<p>"I have not carried a purse since last year. Why? I don't feel safe anymore. And I keep telling myself every day, take your purse, take your purse, take your purse. But I just can't." She is the Community Coordinator of Community Board 12 in her borough and plans to leave New York after she retires.
</p>
<p>"Before, I walked the streets at 2:00, 3:00 in the morning. I was never afraid. Now I don't go out, especially around the holidays. If I were cooking and ran out of something, I'd run to the store no matter what time. Now, I'm not going to the store after 10 PM," says Ursula Greene.
</p>
<p>In 2023, the Bronx had the highest number of summonses per capita, with approximately 17 per 1,000 people. This was followed by Brooklyn, with a rate of 15; Manhattan, with 13; Queens, with 7; and Staten Island, with 5. 
</p>

        <iframe title="The summons in the last decade" aria-label="Interactive area chart" id="datawrapper-chart-BEa7U" src="https://datawrapper.dwcdn.net/BEa7U/5/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="422" data-external="1"></iframe>
        <script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();</script>
   <p> </p>
        <p>The rising summons counts highlight an issue that has affected how the NYPD approaches law enforcement for decades. </p>

    <p>In March 1982, social scientists George Kelling and James Q. Wilson published an article in The Atlantic, popularizing the 'Broken Windows' theory. They argued that crime statistics could be reduced if minor disorders were targeted.
    </p>
    <p>Those minor offenses are also called "quality of life crimes." Former Mayor Rudolph W. Giuliani used the "Broken Windows" theory to deal with crime. The theory suggests that addressing minor crimes helps prevent more serious ones, as punishing small infractions deters more significant criminal activities. For example, they tried to stop "squeegee men," who approached cars at intersections and offered to clean their windshields.
    </p>
    <p>However, the techniques of former Mayor Giuliani have been criticized over time. Professor Bernard E. Harcourt, the Columbia Center for Contemporary Critical Thought director, said, "There is no evidence that policing disorder lowers crime or that broken windows work. But it has had a tremendously disproportionate impact on African-American and Hispanic communities."
    </p>
   <p>The enforcement waned considerably in the 2010s, as evidenced by the significant decline in annual summons. Starting from a high of 490,349 in 2006, the number peaked in 2007 at 539,997 before beginning a downward trend. 
</p>
<p>By 2010, the total remained relatively high but decreased more noticeably. This trend continued throughout the decade, with the numbers falling to 267,950 by 2016 and dramatically dropping in 2017. 
</p>
<p>The decline persisted into the late 2010s. The sharp drop to 55,589 in 2020 came amid the COVID-19 pandemic, significantly impacting public behavior and law enforcement practices. Although there was a slight increase in 2021 and 2022, the number of summonses issued in 2023 shot up to 106,529, indicating a potential shift towards stricter enforcement or changes in societal behavior post-pandemic.
</p>
<p>"Summonses and their relationship to the city involve a quota system that police officers follow, "Eterno said. "This quota system has been in place for several years and is sometimes very stringent. Officers were expected to conduct activities such as stop-and-frisks and issue a certain number of criminal court summonses, sometimes daily. This puts a lot of pressure on them."
</p>
<p>The number of quality-of-life summonses has varied over the past few years. Still, one of the most significant changes happened from 2017 to 2018, when summonses dropped 45 percent after implementing the Criminal Justice Reform Act (CJRA).
</p>
<p>Before this, someone could get a criminal case for littering or drinking in public, and people in New York could be issued criminal summonses for lower-level quality-of-life offenses. This new law transfers cases to civil court instead of criminal court, which can prevent people who walk on grass in parks from getting a permanent criminal record and also decreases warrants.</p>
<p>At that moment, former Mayor de Blasio said, "Using summonses instead of arrests for low-level offenses is an intuitive and modern solution that will help ensure resources are focused on our main priority: addressing threats to public safety."
</p>
<p>The CJRA focused on five particular summonses: open containers of alcohol, park rules like being in the park after hours, littering, public urination, and unreasonable noise. There are reasons behind this: in 2015, the NYPD issued over 150,000 criminal summonses for having an open container of alcohol. 
</p>   
<p>"Over the years, this approach has evolved. A citywide mandate isn't always direct; responses are often localized, with different programs in different places. Even in economically significant areas like Times Square or the heart of Manhattan, there is a noticeable police presence and activity," said Grimsley.
</p>
<p>The Adams administration policies have emphasized enforcing low-level offenses, such as public drinking and gambling, to stop what could lead to fights or violent crimes
</p>
<p>Amid the shifting strategy, the Columbia analysis found that the biggest increases were in precincts like Midwood, Fiske Terrace, Ditmas Park, and Prospect Park South in Brooklyn, going from 105 in 2021 to 2738 in 2023.
</p>
<p>The top list of changes in summonses shows that the precinct of Far Rockaway in Queens went from 98 summons to 2.473 summons in two years, and Lower Manhattan and the Financial District increased from 38 to 407 summons. 
</p>
<p>At the same time, some precincts barely change their amount of summonses, like Flatbush in Brooklyn, Astoria in Queens, and Morningside Heights in Manhattan. 
</p>
<p>The analysis also showed that crimes related to alcohol and drugs are the main issues driving the increase in summonses across the city, followed by disorderly behavior and disobeying business regulations.
</p>
<iframe title="Trend of summonses by category in NYC " aria-label="Interactive line chart" id="datawrapper-chart-WqsYN" src="https://datawrapper.dwcdn.net/WqsYN/1/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="466" data-external="1"></iframe>
<script type="text/javascript">
    !function() {
        "use strict";
        window.addEventListener("message", (function(a) {
            if (void 0 !== a.data["datawrapper-height"]) {
                var e = document.querySelectorAll("iframe");
                for (var t in a.data["datawrapper-height"])
                    for (var r = 0; r < e.length; r++)
                        if (e[r].contentWindow === a.source) {
                            var i = a.data["datawrapper-height"][t] + "px";
                            e[r].style.height = i
                        }
            }
        }))
    }();
</script>
<p>Specific locations where more summonses were handed out in 2023 included 15 River St, Brooklyn, in front of Domino Park, with offenses of alcoholic beverage in public, alcohol consumption, and public urination. Another was 1540 Broadway, Manhattan, in the middle of Times Square, where the offenses included possession of knives, alcohol consumption, sale of loose cigarettes, and noise.
</p>
<p>The third on the list is 229 W 42nd St, next to the Port Authority Bus Terminal. At that location, underage drinking, jaywalking, and harassment are part of the long list of summonses.
</p>
<p>Regardless of the neighborhood trends, most quality-of-life summonses are issued to young men during warmer weather. For example, in 2023, men received 3,620 summonses for public urination and 25,760 for drinking, compared to 67 and 2,289 for women in the same categories.
</p>
<p>Summonses also peak during summer and spring: 62 percent of the summonses occur when the weather is warmer. 
</p>

<iframe title="Weather and summons in NYC" aria-label="Interactive line chart" id="datawrapper-chart-YjPEw" src="https://datawrapper.dwcdn.net/YjPEw/4/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="435" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
</script>

<iframe title="Top Offense Descriptions By Sex in 2023" aria-label="Grouped Columns" id="datawrapper-chart-BP55q" src="https://datawrapper.dwcdn.net/BP55q/2/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="544" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(a){if(void 0!==a.data["datawrapper-height"]){var e=document.querySelectorAll("iframe");for(var t in a.data["datawrapper-height"])for(var r=0;r<e.length;r++)if(e[r].contentWindow===a.source){var i=a.data["datawrapper-height"][t]+"px";e[r].style.height=i}}}))}();
</script>

<p>As the numbers rise, the impact is felt by those working on the streets. One of them is Eduardo, who asked to change his name. "I have had many summonses and haven't paid any of them. First, because I'm not sure how to do it, and second, because I don't want to," says Eduardo from Ecuador, who sells meat in the streets of the Bronx.
</p>
<p>"It's not that I want to be a bad guy or break the rules, but I barely have money, and I can't spend it on those things," he says, standing before his small grill.
</p>
<p>However, as Eduardo is added to the growing list of minor-crime defendants, New Yorkers like George Torres join Greene and Williams with a skeptical view on whether the increased attention will change much of what happens across the streets of New York City. They alternatively praise the heightened attention while also questioning the impact.
</p>
<p>When he arrives at work daily, George Torres sees Eduardo selling meat from his small, precarious grill. Torres is 48 and has been the District Manager of Community Board 12 for the last eight years. He oversees the neighbors' complaints of Edenwald, Wakefield, Williamsbridge, Woodlawn, Fish Bay, Eastchester, Olinville, and Baychester.
</p>
<p>"I grew up in the Bronx, born and raised. I was a teenager in the 90s, and it was a pretty crazy time. I've seen people get killed. I've seen shootings happen in front of me," says George. "I remember sitting on my friend's front stoop, and bullets whizzing by our heads, and I was like, what the hell is that? You thought it was a bee, but not. They were bullets."
</p>
<p>"There are three or four guys who always set up a tent on this sidewalk," says George, pointing at the window of his office on White Plains Rd. So, the other day, I saw them, and I fancy myself somewhat tough: I'll walk through and look at the guys. But I stopped. I don't know what could happen next."
</p>
<p>
    The Community Board, where he works as part of Precinct 47 of New York City, ranks him 8 out of 77 on precinct weapons-related summonses and is in the top 4 on noise related summonses.
    "I like the NYPD," says George Torres. "I mean, I love the NYPD. I'm the son of a cop. But they do nothing to address noise complaints there."
    </p>

    <div class="image-container">
        <img src="police2.jpg" alt="Police gathering next to Washington Square Park" class="large-image">
        <figcaption>Photo credit: Carla Mandiola</figcaption>

    </div>

 <p>Steinkamp is part of the Data Collaborative for Justice, which has studied the relationship between summonses and communities, and interviewed residents of the neighborhoods that received the most criminal summonses. "We asked them if they were concerned about these summonses. Universally, the response was that they weren't concerned. They pointed out that efforts to reduce littering were misguided, especially after removing trash cans in their areas. They suggested that providing public bathrooms could help decrease public urination. They desired more practical resources like additional trash cans and public restrooms."
</p>   
<p>Precincts with higher percentages of summonses relative to their population often have lower average incomes. But it's not always like that. For example, Precinct 14, which includes Times Square, Penn Station Area, Koreatown, and Chelsea, has the highest percentage of summonses per 1,000 people. 
</p>
<p>Jesse Bodine is part of the Manhattan Community Board 4 and works with those neighborhoods. "Crime has been going down, and you're hearing about people complaining about more quality of life issues, not public safety issues. And I think that's an important difference," said Bodine. "If people are complaining about bikes and noise and homelessness rather than murders, stabbings, and robberies, we are going in the right direction."
</p>
<p>According to data from the NYPD, precincts with lower percentages of summonses relative to their population tend to have higher average incomes. The Upper East Side has a rate of one summon per 1000 people and an average income of $130,527.
</p>
<p>Sitting in his office on White Plains Road in the Bronx, where meetings have to be canceled because people don't want to go there at night because it feels dangerous, George Torres said the police are not issuing enough summonses in his area. </p>
<p>"The police should be out there more often. I believe this, but they need to write more summonses because it's not curbing the behavior. You still see cars angling parking; you still can hear shootings. And this will not be solved with a summons now and then." 
</p>
<p>Anna Stenkamp from the Data Collaborative for Justice, says that "there's an argument that people in certain neighborhoods commit more crimes than those in majority-white neighborhoods, attributing the higher number of summonses to specific behaviors. However, data on alcohol and drug consumption rates show consistency across races; the real difference lies in how the law is applied."
</p>
<p>Twenty-two miles from George Torres's office, next to a group of police officers riding horses in Greenwich Village, Jessica Williams said she didn't want to leave her neighborhood. But, she added, it is getting difficult to stay there. 
</p>
<p>"Before, I could go out and walk without worrying too much, but now there's always something happening. It's tiring," says Jessica. "And I see that there are police around; I can't deny it, but there are also more and more people doing whatever they want here."
</p>
<p></p>

</div>
    <div id="map-sidebar-container" style="position: relative;">
        <div id="map-container">
            <div id="map"></div>
            <div id="story">
                <div id="features"></div>
            </div>
        </div>
    
        <div id="sidebar">
            <div>
                <div class="sidebar-header">NYC Summons</div>
                <div id="yearLabel">
                    <span>2018</span>
                    <span>'19</span>
                    <span>'20</span>
                    <span>'21</span>
                    <span>'22</span>
                    <span>2023</span>
                </div>
                <input type="range" id="yearSlider" min="2018" max="2023" value="2023" step="1">
                <div id="search-box-container"></div>
                <div class="sidebar-header2" id="precinctInfo">Categories</div>
                <div id="categoryList"></div>
            </div>
            <div class="sidebar-footer">The map shows the summonses with coordinates from the NYPD crime data</div>
        </div>
    </div>

    <button id="toggleStoryButton">Hide Story</button>
    
    <script>
        var config = {
            style: 'mapbox://styles/carlamandiola/clyw6k9fk00ia01nxco4d4cph',
            accessToken: 'pk.eyJ1IjoiY2FybGFtYW5kaW9sYSIsImEiOiJjbHo2M2x6ZDEybzhoMmpvaWEzemg2bzhyIn0.EorVdgNT0Uj_7ncSDV8NGQ',
            showMarkers: false,
            markerColor: '#3FB1CE',
            inset: true,
            theme: 'dark',
            use3dTerrain: false,
            auto: false,
            title: 'The summons in NYC',
            subtitle: 'How the quality of life enforcement has changed in the city',
            footer: 'Source: source citations, etc. <br> Created using <a href="https://github.com/mapbox/storytelling" target="_blank">Mapbox Storytelling</a> template.',
            chapters: [
                {
                    id: 'chapter1',
                    alignment: 'left',
                    hidden: false,
                    title: 'This was the place with more summonses in NYC in 2018',
                    description: 'People went wild in Times Square, Grand Central Terminal, Penn Station, Madison Square Garden, and Koreatown.',
                    location: {
                        center: [-73.99495, 40.75388],
                        zoom: 14.00,
                        pitch: 62.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter2',
                    alignment: 'right',
                    hidden: false,
                    title: 'Five years later, the south of the Bronx became the place with more summonses in NYC',
                    description: 'In 2023 the precinct that serves Port Morris, Mott Haven, and Melrose had 4,989 summonses',
                    location: {
                        center: [-73.92529, 40.81037],
                        zoom: 14.00,
                        pitch: 51.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter3',
                    alignment: 'left',
                    hidden: false,
                    title: 'Alcohol and drugs are the most common reasons for summonses in the city',
                    description: 'And the place with more tickets is located in Corona, Queens',
                    location: {
                        center: [-73.87012, 40.74513],
                        zoom: 14.00,
                        pitch: 45.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter4',
                    alignment: 'full',
                    hidden: false,
                    title: 'Time to search for addresses',
                    description: 'Use the sidebar to look for areas in NYC and see how the city has changed over the years',
                    location: {
                        center: [-74.0060, 40.7128],
                        zoom: 10.00,
                        pitch: 0.00,
                        bearing: 0.00
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', (event) => {
            mapboxgl.accessToken = config.accessToken;

            const map = new mapboxgl.Map({
                container: 'map',
                center: [-74.0060, 40.7128],
                zoom: 10,
                style: config.style,
                maxBounds: [
                    [-74.259090, 40.477399], // Southwest coordinates
                    [-73.700272, 40.917577]  // Northeast coordinates
                ]
            });

            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                bbox: [-74.2596399, 40.477399, -73.700292, 40.917577],
                mapboxgl: mapboxgl
            });

            document.getElementById('search-box-container').appendChild(geocoder.onAdd(map));

            const colors = {
                'DISORDERLY BEHAVIOR': '#FFAE03',
                'BIKE': '#60a3bc',
                'VEHICLE': '#4a69bd',
                'DISOBEY BUSINESS': '#6ab04c',
                'NOISE': '#cf6a87',
                'PROPERTY': '#861657',
                'ALCOHOL/DRUGS': '#e55039',
                'ALL': '#95afc0'
            };

            const categories = ['DISORDERLY BEHAVIOR', 'DISOBEY BUSINESS', 'ALCOHOL/DRUGS', 'BIKE', 'VEHICLE', 'NOISE', 'PROPERTY'];
            const categoryMap = {
                'DISORDERLY BEHAVIOR': 'DISORDERLY BEHAVIOR',
                'BIKE': 'BIKE',
                'VEHICLE': 'VEHICLE',
                'DISOBEY BUSINESS AND STREET VENDOR REGULATIONS': 'DISOBEY BUSINESS',
                'NOISE': 'NOISE',
                'PROPERTY': 'PROPERTY',
                'ALCOHOL/DRUGS': 'ALCOHOL/DRUGS'
            };
            let summonsData = {};
            let precinctsData = null;
            let currentYear = '2023';
            let averageSummonses = {};

            function calculateAverageSummonses(year) {
                const totalCounts = {};
                const precinctCounts = {};

                categories.forEach(category => {
                    totalCounts[category] = 0;
                    precinctCounts[category] = {};
                });

                summonsData[year].forEach(d => {
                    const category = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (totalCounts.hasOwnProperty(category)) {
                        totalCounts[category]++;
                        if (!precinctCounts[category].hasOwnProperty(d['PRECINCT_OF_OCCUR'])) {
                            precinctCounts[category][d['PRECINCT_OF_OCCUR']] = 0;
                        }
                        precinctCounts[category][d['PRECINCT_OF_OCCUR']]++;
                    }
                });

                categories.forEach(category => {
                    averageSummonses[category] = totalCounts[category] / Object.keys(precinctCounts[category]).length;
                });
            }

            function populateSidebar(counts = {}, precinct = null) {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = ''; // Clear previous list
                categories.forEach(category => {
                    const box = document.createElement('div');
                    box.className = 'category-box';
                    box.style.backgroundColor = colors[category];
                    box.innerHTML = `<span>${category === 'ALCOHOL/DRUGS' ? 'ALCOHOL / DRUGS' : category}</span><span class="category-count" id="${category.replace(/ /g, '-').toLowerCase()}-count">${counts[category] || 0}</span>`;

                    // Add triangle indicators for above/below average only if a precinct is provided
                    if (precinct) {
                        const average = averageSummonses[category];
                        if (counts[category] > average) {
                            box.innerHTML += '<div class="triangle-up"></div><span class="average-label">above average</span>'; // Above average, red triangle
                        } else if (counts[category] < average) {
                            box.innerHTML += '<div class="triangle-down"></div><span class="average-label">below average</span>'; // Below average, green triangle
                        }
                    }

                    box.addEventListener('click', () => filterSummonsLayer(category));
                    categoryList.appendChild(box);
                });
                // Add the "ALL" category box last
                const allBox = document.createElement('div');
                allBox.className = 'category-box';
                allBox.style.backgroundColor = colors['ALL'];
                allBox.innerHTML = `<span>ALL</span><span class="category-count" id="all-count">${counts['ALL'] || 0}</span>`;
                allBox.addEventListener('click', () => filterSummonsLayer('all'));
                categoryList.appendChild(allBox);

                // Update precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                if (precinct) {
                    precinctMessage.innerText = `That address is in precinct ${precinct}, which has this amount of summonses:`;
                } else {
                    precinctMessage.innerText = 'Categories';
                }
            }

            function cleanCoordinate(coord) {
                if (coord === undefined || coord === null) {
                    return null;
                }
                let cleaned = coord.replace(/[^0-9.-]+/g, '');
                return parseFloat(cleaned);
            }

            function mapSummonsData(data) {
                return {
                    type: 'FeatureCollection',
                    features: data.map(d => {
                        const longitude = cleanCoordinate(d.Longitude);
                        const latitude = cleanCoordinate(d.Latitude);
                        if (longitude === null || latitude === null) {
                            return null;
                        }
                        return {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [longitude, latitude]
                            },
                            properties: {
                                offense: d.OFFENSE_DESCRIPTION,
                                precinct: d['PRECINCT_OF_OCCUR'],
                                borough: d.BORO,
                                category: categoryMap[d.CATEGORY] || d.CATEGORY,
                                address: ''
                            }
                        };
                    }).filter(feature => feature !== null)
                };
            }

            function addSummonsLayer(summonsGeoJson) {
                console.log('Adding summons layer with data:', summonsGeoJson);
                if (!map.getSource('summonses')) {
                    map.addSource('summonses', {
                        type: 'geojson',
                        data: summonsGeoJson
                    });
                } else {
                    map.getSource('summonses').setData(summonsGeoJson);
                }

                if (!map.getLayer('summonses')) {
                    map.addLayer({
                        id: 'summonses',
                        type: 'circle',
                        source: 'summonses',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': [
                                'match',
                                ['get', 'category'],
                                ...categories.reduce((acc, category) => [...acc, category, colors[category]], []),
                                colors['ALL']
                            ],
                            'circle-opacity': 0.6
                        }
                    });

                    const summonsPopup = new mapboxgl.Popup({
                        closeButton: false,
                        closeOnClick: false
                    });

                    map.on('mouseenter', 'summonses', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { offense, precinct, borough, category } = e.features[0].properties;

                        getAddress(coordinates).then(address => {
                            e.features[0].properties.address = address;
                            summonsPopup.setLngLat(coordinates).setHTML(`
                                <strong>Offense:</strong> ${offense}<br>
                                <strong>Precinct:</strong> ${precinct}<br>
                                <strong>Borough:</strong> ${borough}<br>
                                <strong>Address:</strong> ${address}
                            `).addTo(map);
                        });
                    });

                    map.on('mouseleave', 'summonses', () => {
                        map.getCanvas().style.cursor = '';
                        summonsPopup.remove();
                    });
                }
            }

            function filterSummonsLayer(category) {
                if (category === 'all') {
                    map.setFilter('summonses', null);
                } else {
                    map.setFilter('summonses', ['==', ['get', 'category'], category]);
                }
            }

            function countSummonsesPerCategory(data) {
                const categoryCounts = { ALL: 0 };
                categories.forEach(category => {
                    categoryCounts[category] = 0;
                });
                data.forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (categoryCounts.hasOwnProperty(mappedCategory)) {
                        categoryCounts[mappedCategory]++;
                        categoryCounts['ALL']++;
                    }
                });
                return categoryCounts;
            }

            function updateMap() {
                calculateAverageSummonses(currentYear);
                const summonsGeoJson = mapSummonsData(summonsData[currentYear]);
                const counts = countSummonsesPerCategory(summonsData[currentYear]);
                populateSidebar(counts);
                addSummonsLayer(summonsGeoJson);
            }

            async function getAddress(coordinates) {
                const [longitude, latitude] = coordinates;
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${mapboxgl.accessToken}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.features[0]?.place_name || 'Address not found';
            }

            async function getCoordinates(address) {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&bbox=-74.2596399,40.477399,-73.700292,40.917577`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].center;
                }
                return null;
            }

            async function getPrecinctByCoordinates(coordinates) {
                if (!precinctsData) {
                    const response = await fetch('nyc_precinct_boundaries.geojson');
                    precinctsData = await response.json();
                }

                const point = turf.point(coordinates);
                for (const feature of precinctsData.features) {
                    if (turf.booleanPointInPolygon(point, feature)) {
                        return feature.properties.precinct;
                    }
                }

                console.error('No precinct found for coordinates:', coordinates);
                return null;
            }

            async function getPrecinctByAddress(address) {
                const coordinates = await getCoordinates(address);
                if (coordinates) {
                    return await getPrecinctByCoordinates(coordinates);
                } else {
                    console.error('No coordinates found for address:', address);
                    return null;
                }
            }

            function updateCategoryCountsForPrecinct(precinct) {
                const counts = { ALL: 0 };
                const precinctData = summonsData[currentYear].filter(d => d['PRECINCT_OF_OCCUR'] == precinct);
                categories.forEach(category => counts[category] = 0);
                precinctData.forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (counts.hasOwnProperty(mappedCategory)) {
                        counts[mappedCategory]++;
                        counts['ALL']++;
                    }
                });

                calculateAverageSummonses(currentYear);
                populateSidebar(counts, precinct);

                // Hide the year slider
                document.getElementById('yearSlider').style.display = 'none';
                document.getElementById('yearLabel').style.display = 'none';
            }

            geocoder.on('result', async (e) => {
                const coordinates = e.result.geometry.coordinates;
                if (coordinates) {
                    const precinct = await getPrecinctByCoordinates(coordinates);
                    if (precinct) {
                        updateCategoryCountsForPrecinct(precinct);
                    } else {
                        alert('Precinct not found for the given address.');
                    }
                } else {
                    alert('Please enter an address.');
                }
            });

            map.on('load', () => {
                console.log('Layers in the map style:', map.getStyle().layers);
                map.getStyle().layers.forEach(layer => {
                    console.log(layer.id);
                });

                populateSidebar();

                Promise.all([
                    d3.csv('yes_2023_corr.csv'),
                    d3.csv('yes_2022_corr.csv'),
                    d3.csv('yes_2021_corr.csv'),
                    d3.csv('yes_2020_corr.csv'),
                    d3.csv('yes_2019_corr.csv'),
                    d3.csv('yes_2018_corr.csv')
                ]).then(([data2023, data2022, data2021, data2020, data2019, data2018]) => {
                    summonsData['2023'] = data2023;
                    summonsData['2022'] = data2022;
                    summonsData['2021'] = data2021;
                    summonsData['2020'] = data2020;
                    summonsData['2019'] = data2019;
                    summonsData['2018'] = data2018;

                    console.log('Data loaded:', summonsData); // Debugging
                    updateMap();
                }).catch(error => {
                    console.error('Error loading the summons CSV files:', error);
                });
            });

            // Handle geocoder clear event to reset the map
            geocoder.on('clear', () => {
                map.flyTo({
                    center: [-74.0060, 40.7128],
                    zoom: 10,
                    speed: 1,
                    curve: 1
                });

                populateSidebar(countSummonsesPerCategory(summonsData[currentYear]));

                // Clear the precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                precinctMessage.innerText = 'Categories';

                // Show the year slider
                document.getElementById('yearSlider').style.display = 'block';
                document.getElementById('yearLabel').style.display = 'flex';
            });

            document.getElementById('yearSlider').addEventListener('input', (e) => {
                currentYear = e.target.value;
                console.log('Year changed:', currentYear); // Debugging
                updateMap();
            });

            // Storytelling integration
            const alignments = {
                'left': 'lefty',
                'center': 'centered',
                'right': 'righty',
                'full': 'fully'
            };

            const story = document.getElementById('story');
            const features = document.createElement('div');
            features.setAttribute('id', 'features');

            const header = document.createElement('div');

            if (config.title) {
                const titleText = document.createElement('h1');
                titleText.innerText = config.title;
                titleText.style.fontFamily = 'Montserrat, sans-serif';
                header.appendChild(titleText);
            }

            if (config.subtitle) {
                const subtitleText = document.createElement('h2');
                subtitleText.innerText = config.subtitle;
                header.appendChild(subtitleText);
            }

            if (config.byline) {
                const bylineText = document.createElement('p');
                bylineText.innerText = config.byline;
                header.appendChild(bylineText);
            }

            if (header.innerText.length > 0) {
                header.classList.add(config.theme);
                header.setAttribute('id', 'header');
                story.appendChild(header);
            }

            config.chapters.forEach((record, idx) => {
                const container = document.createElement('div');
                const chapter = document.createElement('div');

                if (record.title) {
                    const title = document.createElement('h3');
                    title.innerText = record.title;
                    chapter.appendChild(title);
                }

                if (record.image) {
                    const image = new Image();
                    image.src = record.image;
                    chapter.appendChild(image);
                }

                if (record.description) {
                    const storyText = document.createElement('p');
                    storyText.innerHTML = record.description;
                    chapter.appendChild(storyText);
                }

                container.setAttribute('id', record.id);
                container.classList.add('step', 'chapter-box'); // Add chapter-box class
                if (idx === 0) {
                    container.classList.add('active');
                }

                chapter.classList.add(config.theme);
                container.appendChild(chapter);
                container.classList.add(alignments[record.alignment] || 'centered');  // Use the alignments object here
                if (record.hidden) {
                    container.classList.add('hidden');
                }
                features.appendChild(container);
            });

            story.appendChild(features);

            const footer = document.createElement('div');

            if (config.footer) {
                const footerText = document.createElement('p');
                footerText.innerHTML = config.footer;
                footerText.id = 'source-footer';
                footer.appendChild(footerText);
            }

            if (footer.innerText.length > 0) {
                footer.classList.add(config.theme);
                footer.setAttribute('id', 'footer');
                story.appendChild(footer);
            }

            const transformRequest = (url) => {
                const hasQuery = url.indexOf("?") !== -1;
                const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
                return {
                    url: url + suffix
                }
            }

            if (config.showMarkers) {
                const marker = new mapboxgl.Marker({ color: config.markerColor });
                marker.setLngLat(config.chapters[0].location.center).addTo(map);
            }

            const scroller = scrollama();

            map.on("load", function() {
                if (config.use3dTerrain) {
                    map.addSource('mapbox-dem', {
                        'type': 'raster-dem',
                        'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        'tileSize': 512,
                        'maxzoom': 14
                    });
                    map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                    map.addLayer({
                        'id': 'sky',
                        'type': 'sky',
                        'paint': {
                            'sky-type': 'atmosphere',
                            'sky-atmosphere-sun': [0.0, 0.0],
                            'sky-atmosphere-sun-intensity': 15
                        }
                    });
                };

                scroller
                    .setup({
                        step: '.step',
                        offset: 0.5,
                        progress: true,
                        threshold: [0, 0.5, 1] // Ensure this is set to a valid array of numbers between 0 and 1
                    })
                    .onStepEnter(response => {
                        const chapter = config.chapters.find(chap => chap.id === response.element.id);
                        response.element.classList.add('active');
                        map[chapter.mapAnimation || 'flyTo'](chapter.location);

                        if (chapter.onChapterEnter) {
                            chapter.onChapterEnter.forEach(function(layer) {
                                if (layer.layer && map.getLayer(layer.layer)) {
                                    map.setLayoutProperty(layer.layer, 'visibility', 'visible');
                                    map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
                                }
                            });
                        }

                        if (response.index === config.chapters.length - 1) {
                            document.getElementById('sidebar').classList.add('sidebar-visible');
                        }
                    })
                    .onStepExit(response => {
                        const chapter = config.chapters.find(chap => chap.id === response.element.id);
                        response.element.classList.remove('active');

                        if (chapter.onChapterExit) {
                            chapter.onChapterExit.forEach(function(layer) {
                                if (layer.layer && map.getLayer(layer.layer)) {
                                    map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
                                }
                            });
                        }

                        if (response.index === config.chapters.length - 1 && response.direction === 'down') {
                            document.getElementById('story').style.display = 'none';
                            document.getElementById('toggleStoryButton').innerText = 'Show Story';
                        }
                    });

                if (config.auto) {
                    document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
                }
            });

            window.addEventListener('resize', scroller.resize);

            document.getElementById('toggleStoryButton').addEventListener('click', () => {
                const storyDiv = document.getElementById('story');
                const toggleButton = document.getElementById('toggleStoryButton');
                if (storyDiv.style.display === 'none') {
                    storyDiv.style.display = 'block';
                    toggleButton.innerText = 'Hide Story';
                } else {
                    storyDiv.style.display = 'none';
                    toggleButton.innerText = 'Show Story';
                }
            });

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.getElementById('sidebar').classList.add('sidebar-visible');
                        document.getElementById('toggleStoryButton').style.display = 'block'; // Show button when map is in view
                        document.getElementById('story').style.display = 'block'; // Show story sidebar when map is in view
                    } else {
                        document.getElementById('sidebar').classList.remove('sidebar-visible');
                        document.getElementById('toggleStoryButton').style.display = 'none'; // Hide button when map is not in view
                        document.getElementById('story').style.display = 'none'; // Hide story sidebar when map is not in view
                    }
                });
            }, { threshold: 0.5 });

            observer.observe(document.getElementById('map-container'));
        });

    </script>
</body>

</html>
