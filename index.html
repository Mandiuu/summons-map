<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Look at NYC Summons</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Shrikhand&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Lato', sans-serif;
            font-size: 20px;
            line-height: 1.4;
            display: flex;
        }

        #sidebar {
            width: 300px;
            background: #333;
            color: white;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #categoryList {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-box {
            width: calc(40% - 10px);
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 10px;
            color: white;
            text-align: center;
            border: none;
            cursor: pointer;
            flex-direction: column;
            box-sizing: border-box;
            font-size: 12px;
            position: relative;
        }

        .category-box span:first-child {
            font-weight: bold;
            font-size: 16px;
        }

        .category-box span:nth-child(2) {
            font-size: 14px;
        }

        .triangle-up {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid red;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        .triangle-down {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid green;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        #map {
            flex-grow: 1;
            height: 100%;
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Lato', Arial, Helvetica, sans-serif;
        }

        #yearSlider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.9;
            margin: 20px 0;
            position: relative;
        }

        #yearSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearLabel {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            margin-top: 10px;
        }

        .sidebar-footer {
            font-size: 12px;
            color: white;
            text-align: right;
        }

        .sidebar-header {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 0px;
        }

        .sidebar-header2 {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 30px;
        }

        .mapboxgl-ctrl-geocoder--input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Lato', sans-serif;
            box-sizing: border-box;
        }

        .mapboxgl-ctrl-geocoder--icon-search {
            width: 15px;
            height: 15px;
            left: 1px;
            margin-left: 10px;
        }

        .mapboxgl-ctrl-geocoder--input::placeholder {
            padding-left: 25px;
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 100px;
                font-size: 16px;
            }

            .category-box {
                font-size: 12px;
                width: calc(50% - 10px);
            }

            #yearLabel, .sidebar-header, .sidebar-header2 {
                font-size: 16px;
            }

            .sidebar-footer {
                font-size: 10px;
            }

            .mapboxgl-popup {
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div>
            <div class="sidebar-header">NYC Summons</div>
            <div id="yearLabel">
                <span>2018</span>
                <span>'19</span>
                <span>'20</span>
                <span>'21</span>
                <span>'22</span>
                <span>2023</span>
            </div>
            <input type="range" id="yearSlider" min="2018" max="2023" value="2023" step="1">
            <div id="search-box-container"></div>
            <div class="sidebar-header2" id="precinctInfo">Categories</div>
            <div id="categoryList"></div>
        </div>
        <div class="sidebar-footer">By Carla Mandiola</div>
    </div>
    <div id="map"></div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            mapboxgl.accessToken = 'pk.eyJ1IjoiY2FybGFtYW5kaW9sYSIsImEiOiJjbHo2M2x6ZDEybzhoMmpvaWEzemg2bzhyIn0.EorVdgNT0Uj_7ncSDV8NGQ';

            const map = new mapboxgl.Map({
                container: 'map',
                center: [-74.0060, 40.7128],
                zoom: 10,
                style: 'mapbox://styles/carlamandiola/clyw6k9fk00ia01nxco4d4cph',
                maxBounds: [
                    [-74.259090, 40.477399], // Southwest coordinates
                    [-73.700272, 40.917577]  // Northeast coordinates
                ]
            });

            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                bbox: [-74.2596399, 40.477399, -73.700292, 40.917577],
                mapboxgl: mapboxgl
            });

            document.getElementById('search-box-container').appendChild(geocoder.onAdd(map));

            const colors = {
                'DISORDERLY BEHAVIOR': '#f6b93b',
                'BIKE': '#60a3bc',
                'VEHICLE': '#4a69bd',
                'DISOBEY BUSINESS': '#A3CB38',
                'NOISE': '#cf6a87',
                'PROPERTY': '#574b90',
                'ALCOHOL/DRUGS': '#e55039',
                'ALL': '#95afc0'
            };

            const categories = ['DISORDERLY BEHAVIOR', 'BIKE', 'VEHICLE', 'DISOBEY BUSINESS', 'NOISE', 'PROPERTY', 'ALCOHOL/DRUGS'];
            const categoryMap = {
                'DISORDERLY BEHAVIOR': 'DISORDERLY BEHAVIOR',
                'BIKE': 'BIKE',
                'VEHICLE': 'VEHICLE',
                'DISOBEY BUSINESS AND STREET VENDOR REGULATIONS': 'DISOBEY BUSINESS',
                'NOISE': 'NOISE',
                'PROPERTY': 'PROPERTY',
                'ALCOHOL/DRUGS': 'ALCOHOL/DRUGS'
            };
            let summonsData = {};
            let precinctsData = null;
            let currentYear = '2023';
            let averageSummonses = {};

            function calculateAverageSummonses() {
                const totalCounts = {};
                const precinctCounts = {};

                categories.forEach(category => {
                    totalCounts[category] = 0;
                    precinctCounts[category] = {};
                });

                for (let year in summonsData) {
                    summonsData[year].forEach(d => {
                        const category = categoryMap[d.CATEGORY] || d.CATEGORY;
                        if (totalCounts.hasOwnProperty(category)) {
                            totalCounts[category]++;
                            if (!precinctCounts[category].hasOwnProperty(d['PRECINCT_OF_OCCUR'])) {
                                precinctCounts[category][d['PRECINCT_OF_OCCUR']] = 0;
                            }
                            precinctCounts[category][d['PRECINCT_OF_OCCUR']]++;
                        }
                    });
                }

                categories.forEach(category => {
                    averageSummonses[category] = totalCounts[category] / Object.keys(precinctCounts[category]).length;
                });
            }

            function populateSidebar(counts = {}, precinct = null) {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = ''; // Clear previous list
                categories.forEach(category => {
                    const box = document.createElement('div');
                    box.className = 'category-box';
                    box.style.backgroundColor = colors[category];
                    box.innerHTML = `<span>${category}</span><span class="category-count" id="${category.replace(/ /g, '-').toLowerCase()}-count">${counts[category] || 0}</span>`;

                    // Add triangle indicators for above/below average
                    if (precinct) {
                        const count = counts[category] || 0;
                        if (count > averageSummonses[category]) {
                            box.innerHTML += '<div class="triangle-up"></div>'; // Above average, red triangle
                        } else if (count < averageSummonses[category]) {
                            box.innerHTML += '<div class="triangle-down"></div>'; // Below average, green triangle
                        }
                    }

                    box.addEventListener('click', () => filterSummonsLayer(category));
                    categoryList.appendChild(box);
                });
                // Add the "ALL" category box last
                const allBox = document.createElement('div');
                allBox.className = 'category-box';
                allBox.style.backgroundColor = colors['ALL'];
                allBox.innerHTML = `<span>ALL</span><span class="category-count" id="all-count">${counts['ALL'] || 0}</span>`;
                allBox.addEventListener('click', () => filterSummonsLayer('all'));
                categoryList.appendChild(allBox);

                // Update precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                if (precinct) {
                    precinctMessage.innerText = `That address is in the ${precinct} precinct. This is the amount of summonses:`;
                } else {
                    precinctMessage.innerText = 'Categories';
                }
            }

            function cleanCoordinate(coord) {
                if (coord === undefined || coord === null) {
                    return null;
                }
                let cleaned = coord.replace(/[^0-9.-]+/g, '');
                return parseFloat(cleaned);
            }

            function mapSummonsData(data) {
                return {
                    type: 'FeatureCollection',
                    features: data.map(d => {
                        const longitude = cleanCoordinate(d.Longitude);
                        const latitude = cleanCoordinate(d.Latitude);
                        if (longitude === null || latitude === null) {
                            return null;
                        }
                        return {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [longitude, latitude]
                            },
                            properties: {
                                offense: d.OFFENSE_DESCRIPTION,
                                precinct: d['PRECINCT_OF_OCCUR'],
                                borough: d.BORO,
                                category: categoryMap[d.CATEGORY] || d.CATEGORY,
                                address: ''
                            }
                        };
                    }).filter(feature => feature !== null)
                };
            }

            function addSummonsLayer(summonsGeoJson) {
                console.log('Adding summons layer with data:', summonsGeoJson);
                if (map.getSource('summonses')) {
                    map.getSource('summonses').setData(summonsGeoJson);
                } else {
                    map.addSource('summonses', {
                        type: 'geojson',
                        data: summonsGeoJson
                    });

                    map.addLayer({
                        id: 'summonses',
                        type: 'circle',
                        source: 'summonses',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': [
                                'match',
                                ['get', 'category'],
                                ...categories.reduce((acc, category) => [...acc, category, colors[category]], []),
                                colors['ALL']
                            ],
                            'circle-opacity': 0.6
                        }
                    });

                    const summonsPopup = new mapboxgl.Popup({
                        closeButton: false,
                        closeOnClick: false
                    });

                    map.on('mouseenter', 'summonses', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { offense, precinct, borough, category } = e.features[0].properties;

                        getAddress(coordinates).then(address => {
                            e.features[0].properties.address = address;
                            summonsPopup.setLngLat(coordinates).setHTML(`
                                <strong>Offense:</strong> ${offense}<br>
                                <strong>Precinct:</strong> ${precinct}<br>
                                <strong>Borough:</strong> ${borough}<br>
                                <strong>Address:</strong> ${address}
                            `).addTo(map);
                        });
                    });

                    map.on('mouseleave', 'summonses', () => {
                        map.getCanvas().style.cursor = '';
                        summonsPopup.remove();
                    });
                }
            }

            function filterSummonsLayer(category) {
                if (category === 'all') {
                    map.setFilter('summonses', null);
                } else {
                    map.setFilter('summonses', ['==', ['get', 'category'], category]);
                }
            }

            function countSummonsesPerCategory(data) {
                const categoryCounts = { ALL: 0 };
                categories.forEach(category => {
                    categoryCounts[category] = 0;
                });
                data.forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (categoryCounts.hasOwnProperty(mappedCategory)) {
                        categoryCounts[mappedCategory]++;
                        categoryCounts['ALL']++;
                    }
                });
                return categoryCounts;
            }

            function updateMap() {
                const summonsGeoJson = mapSummonsData(summonsData[currentYear]);
                const counts = countSummonsesPerCategory(summonsData[currentYear]);
                populateSidebar(counts);
                addSummonsLayer(summonsGeoJson);
            }

            async function getAddress(coordinates) {
                const [longitude, latitude] = coordinates;
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${mapboxgl.accessToken}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.features[0]?.place_name || 'Address not found';
            }

            async function getCoordinates(address) {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&bbox=-74.2596399,40.477399,-73.700292,40.917577`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].center;
                }
                return null;
            }

            async function getPrecinctByCoordinates(coordinates) {
                if (!precinctsData) {
                    const response = await fetch('nyc_precinct_boundaries.geojson');
                    precinctsData = await response.json();
                }

                const point = turf.point(coordinates);
                for (const feature of precinctsData.features) {
                    if (turf.booleanPointInPolygon(point, feature)) {
                        return feature.properties.precinct;
                    }
                }

                console.error('No precinct found for coordinates:', coordinates);
                return null;
            }

            async function getPrecinctByAddress(address) {
                const coordinates = await getCoordinates(address);
                if (coordinates) {
                    return await getPrecinctByCoordinates(coordinates);
                } else {
                    console.error('No coordinates found for address:', address);
                    return null;
                }
            }

            function updateCategoryCountsForPrecinct(precinct) {
                const counts = { ALL: 0 };
                categories.forEach(category => counts[category] = 0);
                summonsData[currentYear].forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (d['PRECINCT_OF_OCCUR'] == precinct) {
                        if (counts.hasOwnProperty(mappedCategory)) {
                            counts[mappedCategory]++;
                            counts['ALL']++;
                        }
                    }
                });
                populateSidebar(counts, precinct);
            }

            geocoder.on('result', async (e) => {
                const coordinates = e.result.geometry.coordinates;
                if (coordinates) {
                    const precinct = await getPrecinctByCoordinates(coordinates);
                    if (precinct) {
                        updateCategoryCountsForPrecinct(precinct);
                    } else {
                        alert('Precinct not found for the given address.');
                    }
                } else {
                    alert('Please enter an address.');
                }
            });

            map.on('load', () => {
                populateSidebar();

                Promise.all([
                    d3.csv('yes_2023_corr.csv'),
                    d3.csv('yes_2022_corr.csv'),
                    d3.csv('yes_2021_corr.csv'),
                    d3.csv('yes_2020_corr.csv'),
                    d3.csv('yes_2019_corr.csv'),
                    d3.csv('yes_2018_corr.csv')
                ]).then(([data2023, data2022, data2021, data2020, data2019, data2018]) => {
                    summonsData['2023'] = data2023;
                    summonsData['2022'] = data2022;
                    summonsData['2021'] = data2021;
                    summonsData['2020'] = data2020;
                    summonsData['2019'] = data2019;
                    summonsData['2018'] = data2018;

                    calculateAverageSummonses();
                    updateMap();
                }).catch(error => {
                    console.error('Error loading the summons CSV files:', error);
                });
            });

            // Handle geocoder clear event to reset the map
            geocoder.on('clear', () => {
                map.flyTo({
                    center: [-74.0060, 40.7128],
                    zoom: 10,
                    speed: 1,
                    curve: 1
                });

                populateSidebar(countSummonsesPerCategory(summonsData[currentYear]));

                // Clear the precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                precinctMessage.innerText = 'Categories';
            });

            document.getElementById('yearSlider').addEventListener('input', (e) => {
                currentYear = e.target.value;
                updateMap();
            });
        });
    </script>
</body>
</html>
