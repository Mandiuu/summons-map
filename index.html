<!DOCTYPE html>
<html lang="en">
<head>
       <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Look at NYC Summons</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Shrikhand&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&family=Teachers:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://unpkg.com/intersection-observer@0.12.0/intersection-observer.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            line-height: 1.4;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        #sidebar {
            width: 300px;
            font-family: 'Montserrat', sans-serif;
            background: #333;
            color: white;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 1;
            display: none; /* Hide by default */
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar-visible {
            display: flex !important; /* Show when this class is added */
        }

        #categoryList {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-box {
    width: calc(40% - 10px);
    height: 100px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 10px;
    color: white;
    text-align: center;
    border: none;
    cursor: pointer;
    flex-direction: column;
    box-sizing: border-box;
    font-size: 12px;
    position: relative;
}

.category-box span:first-child {
    font-weight: bold;
    font-size: 13px;
    margin-bottom: auto;
    white-space: normal;
    word-break: break-word;
    text-align: center;
}

.category-box span:nth-child(2) {
    font-weight: bold;
    font-size: 25px;
    margin-top: -2px; /* Add some space above the number */
}

        .category-count {
            font-weight: bold;
            font-size: 21px;
            margin-bottom: auto; /* This will push the element to the top */
        }

        .triangle-up {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid red;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        .triangle-down {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid green;
            position: absolute;
            bottom: 5px;
            left: 5px;
            -webkit-filter: drop-shadow(0 0 2px white);
            filter: drop-shadow(0 0 2px white);
        }

        #map {
            flex-grow: 1;
            height: 100%;
            width: 100vw; 
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Lato', Arial, Helvetica, sans-serif;
        }

        #yearSlider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.9;
            margin: 20px 0;
            position: relative;
        }

        #yearSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #FF69B4;
            cursor: pointer;
            border-radius: 50%;
        }

        #yearLabel {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            margin-top: 10px;
        }

        .sidebar-footer {
            font-size: 12px;
            color: white;
            text-align: right;
        }

        .sidebar-header {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 0px;
        }

        .sidebar-header2 {
            text-align: left;
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
            margin-top: 30px;
        }

        .mapboxgl-ctrl-geocoder--input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Lato', sans-serif;
            box-sizing: border-box;
        }

        .mapboxgl-ctrl-geocoder--icon-search {
            width: 15px;
            height: 15px;
            left: 1px;
            margin-left: 10px;
        }

        .mapboxgl-ctrl-geocoder--input::placeholder {
            padding-left: 25px;
        }

        .header, .footer {
            text-align: center;
            padding: 10px 0;
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
            font-family: "Teachers", sans-serif;
        }

        .header h2 {
            margin: 0;
            font-size: 1.2em;
            color: gray;
        }

        .byline {
            margin: 20px 0;
            text-align: center;
            font-style: italic;
        }

        .footer {
            margin-top: 50px;
            font-size: 0.9em;
            color: gray;
        }

        .average-label {
            font-size: 10px;
            color: white;
            position: absolute;
            bottom: 5px;
            left: 30px; /* Adjust this value as needed to move the text left */
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 150px;
                height: auto;
                font-size: 16px;
                position: absolute;
                top: 0;
                right: 0;
                z-index: 2;
                display: none; /* Hide by default on mobile */
                flex-direction: column;
                flex-wrap: wrap;
                justify-content: space-around;
            }

            .category-box {
                font-size: 12px;
                width: calc(100% - 20px);
                height: 80px;
            }

            #yearLabel, .sidebar-header, .sidebar-header2 {
                font-size: 16px;
            }

            .sidebar-footer {
                font-size: 10px;
            }

            .mapboxgl-popup {
                font-size: 10px;
            }

            #map {
                width: 100%;
                height: 100%;
            }

            #toggleStoryButton {
                bottom: 60px; /* Adjust to fit above the sidebar */
                right: 160px; /* Adjust to fit next to the sidebar */
            }
        }

        #story {
            width: 300px;
            overflow-y: auto;
            z-index: 2;
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            background: none;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .step {
            margin-bottom: 200px;
            opacity: 0.3;
            transition: opacity 0.5s;
        }

        .step.active {
            opacity: 1;
        }

        .step h3 {
            margin: 0;
            padding: 0;
            font-size: 1.5em;
            color: #333;
        }

        .step p {
            margin: 10px 0 0;
            padding: 0;
            font-size: 1em;
            color: #666;
        }

        .chapter-box {
            padding: 20px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        #header, #footer {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #toggleStoryButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 3;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3FB1CE;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>The summons in NYC</h1>
    </div>
    <div id="sidebar">
        <div>
            <div class="sidebar-header">NYC Summons</div>
            <div id="yearLabel">
                <span>2018</span>
                <span>'19</span>
                <span>'20</span>
                <span>'21</span>
                <span>'22</span>
                <span>2023</span>
            </div>
            <input type="range" id="yearSlider" min="2018" max="2023" value="2023" step="1">
            <div id="search-box-container"></div>
            <div class="sidebar-header2" id="precinctInfo">Categories</div>
            <div id="categoryList"></div>
        </div>
        <div class="sidebar-footer">By Carla Mandiola</div>
    </div>
    <div id="map"></div>
    <div id="story"></div>
    <button id="toggleStoryButton">Hide Story</button>

    <script>
        var config = {
            style: 'mapbox://styles/carlamandiola/clyw6k9fk00ia01nxco4d4cph',
            accessToken: 'pk.eyJ1IjoiY2FybGFtYW5kaW9sYSIsImEiOiJjbHo2M2x6ZDEybzhoMmpvaWEzemg2bzhyIn0.EorVdgNT0Uj_7ncSDV8NGQ',
            showMarkers: true,
            markerColor: '#3FB1CE',
            inset: true,
            theme: 'dark',
            use3dTerrain: false,
            auto: false,
            title: 'The summons in NYC',
            subtitle: 'How the quality of life enforcement has changed in the city',
            byline: 'By Carla Mandiola',
            footer: 'Source: source citations, etc. <br> Created using <a href="https://github.com/mapbox/storytelling" target="_blank">Mapbox Storytelling</a> template.',
            chapters: [
                {
                    id: 'chapter1',
                    alignment: 'left',
                    hidden: false,
                    title: 'This was the place with more summonses in NYC in 2018',
                    description: 'People went wild im Times Square, Grand Central Terminal, Penn Station, Madison Square Garden, and Koreatown.',
                    location: {
                        center: [-73.99495, 40.75388],
                        zoom: 14.00,
                        pitch: 62.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter2',
                    alignment: 'right',
                    hidden: false,
                    title: 'Five years later, the south of the Bronx became the place with more summonses in NYC',
                    description: 'In 2023 the precinct that serves Port Morris, Mott Haven, and Melrose had 4.989 summonses',
                    location: {
                        center: [-73.92529, 40.81037],
                        zoom: 14.00,
                        pitch: 51.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter3',
                    alignment: 'left',
                    hidden: false,
                    title: 'Alcohol and drugs are the most common reasons for summonses in the city',
                    description: 'And the place with more tickets is located in Corona, Queens',
                    location: {
                        center: [-73.87012, 40.74513],
                        zoom: 14.00,
                        pitch: 45.00,
                        bearing: 25.73
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                },
                {
                    id: 'chapter4',
                    alignment: 'full',
                    hidden: false,
                    title: 'Time to search for addresses',
                    description: 'Use the sidebar to look for areas in NYC and see how the city has changed over the years',
                    location: {
                        center: [-74.0060, 40.7128],
                        zoom: 10.00,
                        pitch: 0.00,
                        bearing: 0.00
                    },
                    mapAnimation: 'flyTo',
                    rotateAnimation: false,
                    onChapterEnter: [],
                    onChapterExit: []
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', (event) => {
            mapboxgl.accessToken = config.accessToken;

            const map = new mapboxgl.Map({
                container: 'map',
                center: [-74.0060, 40.7128],
                zoom: 10,
                style: config.style,
                maxBounds: [
                    [-74.259090, 40.477399], // Southwest coordinates
                    [-73.700272, 40.917577]  // Northeast coordinates
                ]
            });

            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                bbox: [-74.2596399, 40.477399, -73.700292, 40.917577],
                mapboxgl: mapboxgl
            });

            document.getElementById('search-box-container').appendChild(geocoder.onAdd(map));

            const colors = {
                'DISORDERLY BEHAVIOR': '#f9ca24',
                'BIKE': '#60a3bc',
                'VEHICLE': '#4a69bd',
                'DISOBEY BUSINESS': '#6ab04c',
                'NOISE': '#cf6a87',
                'PROPERTY': '#574b90',
                'ALCOHOL/DRUGS': '#e55039',
                'ALL': '#95afc0'
            };

            const categories = ['DISORDERLY BEHAVIOR', 'DISOBEY BUSINESS', 'ALCOHOL/DRUGS', 'BIKE', 'VEHICLE','NOISE', 'PROPERTY'];
            const categoryMap = {
                'DISORDERLY BEHAVIOR': 'DISORDERLY BEHAVIOR',
                'BIKE': 'BIKE',
                'VEHICLE': 'VEHICLE',
                'DISOBEY BUSINESS AND STREET VENDOR REGULATIONS': 'DISOBEY BUSINESS',
                'NOISE': 'NOISE',
                'PROPERTY': 'PROPERTY',
                'ALCOHOL/DRUGS': 'ALCOHOL/DRUGS'
            };
            let summonsData = {};
            let precinctsData = null;
            let currentYear = '2023';
            let averageSummonses = {};

            function calculateAverageSummonses(year) {
                const totalCounts = {};
                const precinctCounts = {};

                categories.forEach(category => {
                    totalCounts[category] = 0;
                    precinctCounts[category] = {};
                });

                summonsData[year].forEach(d => {
                    const category = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (totalCounts.hasOwnProperty(category)) {
                        totalCounts[category]++;
                        if (!precinctCounts[category].hasOwnProperty(d['PRECINCT_OF_OCCUR'])) {
                            precinctCounts[category][d['PRECINCT_OF_OCCUR']] = 0;
                        }
                        precinctCounts[category][d['PRECINCT_OF_OCCUR']]++;
                    }
                });

                categories.forEach(category => {
                    averageSummonses[category] = totalCounts[category] / Object.keys(precinctCounts[category]).length;
                });
            }

            function populateSidebar(counts = {}, precinct = null) {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = ''; // Clear previous list
                categories.forEach(category => {
                    const box = document.createElement('div');
                    box.className = 'category-box';
                    box.style.backgroundColor = colors[category];
                    box.innerHTML = `<span>${category === 'ALCOHOL/DRUGS' ? 'ALCOHOL / DRUGS' : category}</span><span class="category-count" id="${category.replace(/ /g, '-').toLowerCase()}-count">${counts[category] || 0}</span>`;

                    // Add triangle indicators for above/below average only if a precinct is provided
                    if (precinct) {
                        const average = averageSummonses[category];
                        if (counts[category] > average) {
                            box.innerHTML += '<div class="triangle-up"></div><span class="average-label">above average</span>'; // Above average, red triangle
                        } else if (counts[category] < average) {
                            box.innerHTML += '<div class="triangle-down"></div><span class="average-label">below average</span>'; // Below average, green triangle
                        }
                    }

                    box.addEventListener('click', () => filterSummonsLayer(category));
                    categoryList.appendChild(box);
                });
                // Add the "ALL" category box last
                const allBox = document.createElement('div');
                allBox.className = 'category-box';
                allBox.style.backgroundColor = colors['ALL'];
                allBox.innerHTML = `<span>ALL</span><span class="category-count" id="all-count">${counts['ALL'] || 0}</span>`;
                allBox.addEventListener('click', () => filterSummonsLayer('all'));
                categoryList.appendChild(allBox);

                // Update precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                if (precinct) {
                    precinctMessage.innerText = `That address is in precinct ${precinct}, which has this amount of summonses:`;
                } else {
                    precinctMessage.innerText = 'Categories';
                }
            }

            function cleanCoordinate(coord) {
                if (coord === undefined || coord === null) {
                    return null;
                }
                let cleaned = coord.replace(/[^0-9.-]+/g, '');
                return parseFloat(cleaned);
            }

            function mapSummonsData(data) {
                return {
                    type: 'FeatureCollection',
                    features: data.map(d => {
                        const longitude = cleanCoordinate(d.Longitude);
                        const latitude = cleanCoordinate(d.Latitude);
                        if (longitude === null || latitude === null) {
                            return null;
                        }
                        return {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [longitude, latitude]
                            },
                            properties: {
                                offense: d.OFFENSE_DESCRIPTION,
                                precinct: d['PRECINCT_OF_OCCUR'],
                                borough: d.BORO,
                                category: categoryMap[d.CATEGORY] || d.CATEGORY,
                                address: ''
                            }
                        };
                    }).filter(feature => feature !== null)
                };
            }

            function addSummonsLayer(summonsGeoJson) {
                console.log('Adding summons layer with data:', summonsGeoJson);
                if (map.getSource('summonses')) {
                    map.getSource('summonses').setData(summonsGeoJson);
                } else {                    map.addSource('summonses', {
                        type: 'geojson',
                        data: summonsGeoJson
                    });

                    map.addLayer({
                        id: 'summonses',
                        type: 'circle',
                        source: 'summonses',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': [
                                'match',
                                ['get', 'category'],
                                ...categories.reduce((acc, category) => [...acc, category, colors[category]], []),
                                colors['ALL']
                            ],
                            'circle-opacity': 0.6
                        }
                    });

                    const summonsPopup = new mapboxgl.Popup({
                        closeButton: false,
                        closeOnClick: false
                    });

                    map.on('mouseenter', 'summonses', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { offense, precinct, borough, category } = e.features[0].properties;

                        getAddress(coordinates).then(address => {
                            e.features[0].properties.address = address;
                            summonsPopup.setLngLat(coordinates).setHTML(`
                                <strong>Offense:</strong> ${offense}<br>
                                <strong>Precinct:</strong> ${precinct}<br>
                                <strong>Borough:</strong> ${borough}<br>
                                <strong>Address:</strong> ${address}
                            `).addTo(map);
                        });
                    });

                    map.on('mouseleave', 'summonses', () => {
                        map.getCanvas().style.cursor = '';
                        summonsPopup.remove();
                    });
                }
            }

            function filterSummonsLayer(category) {
                if (category === 'all') {
                    map.setFilter('summonses', null);
                } else {
                    map.setFilter('summonses', ['==', ['get', 'category'], category]);
                }
            }

            function countSummonsesPerCategory(data) {
                const categoryCounts = { ALL: 0 };
                categories.forEach(category => {
                    categoryCounts[category] = 0;
                });
                data.forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (categoryCounts.hasOwnProperty(mappedCategory)) {
                        categoryCounts[mappedCategory]++;
                        categoryCounts['ALL']++;
                    }
                });
                return categoryCounts;
            }

            function updateMap() {
                calculateAverageSummonses(currentYear);
                const summonsGeoJson = mapSummonsData(summonsData[currentYear]);
                const counts = countSummonsesPerCategory(summonsData[currentYear]);
                populateSidebar(counts);
                addSummonsLayer(summonsGeoJson);
            }

            async function getAddress(coordinates) {
                const [longitude, latitude] = coordinates;
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${mapboxgl.accessToken}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.features[0]?.place_name || 'Address not found';
            }

            async function getCoordinates(address) {
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&bbox=-74.2596399,40.477399,-73.700292,40.917577`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.features.length > 0) {
                    return data.features[0].center;
                }
                return null;
            }

            async function getPrecinctByCoordinates(coordinates) {
                if (!precinctsData) {
                    const response = await fetch('nyc_precinct_boundaries.geojson');
                    precinctsData = await response.json();
                }

                const point = turf.point(coordinates);
                for (const feature of precinctsData.features) {
                    if (turf.booleanPointInPolygon(point, feature)) {
                        return feature.properties.precinct;
                    }
                }

                console.error('No precinct found for coordinates:', coordinates);
                return null;
            }

            async function getPrecinctByAddress(address) {
                const coordinates = await getCoordinates(address);
                if (coordinates) {
                    return await getPrecinctByCoordinates(coordinates);
                } else {
                    console.error('No coordinates found for address:', address);
                    return null;
                }
            }

            function updateCategoryCountsForPrecinct(precinct) {
                const counts = { ALL: 0 };
                const precinctData = summonsData[currentYear].filter(d => d['PRECINCT_OF_OCCUR'] == precinct);
                categories.forEach(category => counts[category] = 0);
                precinctData.forEach(d => {
                    const mappedCategory = categoryMap[d.CATEGORY] || d.CATEGORY;
                    if (counts.hasOwnProperty(mappedCategory)) {
                        counts[mappedCategory]++;
                        counts['ALL']++;
                    }
                });

                calculateAverageSummonses(currentYear);
                populateSidebar(counts, precinct);

                // Hide the year slider
                document.getElementById('yearSlider').style.display = 'none';
                document.getElementById('yearLabel').style.display = 'none';
            }

            geocoder.on('result', async (e) => {
                const coordinates = e.result.geometry.coordinates;
                if (coordinates) {
                    const precinct = await getPrecinctByCoordinates(coordinates);
                    if (precinct) {
                        updateCategoryCountsForPrecinct(precinct);
                    } else {
                        alert('Precinct not found for the given address.');
                    }
                } else {
                    alert('Please enter an address.');
                }
            });

            map.on('load', () => {
                console.log('Layers in the map style:', map.getStyle().layers);
                map.getStyle().layers.forEach(layer => {
                    console.log(layer.id);
                });

                // Add custom layer for demonstration purposes
                map.addLayer({
                    'id': 'summonses', // Custom layer ID
                    'type': 'circle',
                    'source': 'summonses',
                    'paint': {
                        'circle-radius': 5,
                        'circle-color': '#f00',
                        'circle-opacity': 0.6
                    }
                });

                populateSidebar();

                Promise.all([
                    d3.csv('yes_2023_corr.csv'),
                    d3.csv('yes_2022_corr.csv'),
                    d3.csv('yes_2021_corr.csv'),
                    d3.csv('yes_2020_corr.csv'),
                    d3.csv('yes_2019_corr.csv'),
                    d3.csv('yes_2018_corr.csv')
                ]).then(([data2023, data2022, data2021, data2020, data2019, data2018]) => {
                    summonsData['2023'] = data2023;
                    summonsData['2022'] = data2022;
                    summonsData['2021'] = data2021;
                    summonsData['2020'] = data2020;
                    summonsData['2019'] = data2019;
                    summonsData['2018'] = data2018;

                    console.log('Data loaded:', summonsData); // Debugging
                    updateMap();
                }).catch(error => {
                    console.error('Error loading the summons CSV files:', error);
                });
            });

            // Handle geocoder clear event to reset the map
            geocoder.on('clear', () => {
                map.flyTo({
                    center: [-74.0060, 40.7128],
                    zoom: 10,
                    speed: 1,
                    curve: 1
                });

                populateSidebar(countSummonsesPerCategory(summonsData[currentYear]));

                // Clear the precinct message
                const precinctMessage = document.getElementById('precinctInfo');
                precinctMessage.innerText = 'Categories';

                // Show the year slider
                document.getElementById('yearSlider').style.display = 'block';
                document.getElementById('yearLabel').style.display = 'flex';
            });

            document.getElementById('yearSlider').addEventListener('input', (e) => {
                currentYear = e.target.value;
                console.log('Year changed:', currentYear); // Debugging
                updateMap();
            });

            // Storytelling integration
            const alignments = {
                'left': 'lefty',
                'center': 'centered',
                'right': 'righty',
                'full': 'fully'
            };

            const story = document.getElementById('story');
            const features = document.createElement('div');
            features.setAttribute('id', 'features');

            const header = document.createElement('div');

            if (config.title) {
                const titleText = document.createElement('h1');
                titleText.innerText = config.title;
                titleText.style.fontFamily = 'Montserrat, sans-serif';
                header.appendChild(titleText);
            }

            if (config.subtitle) {
                const subtitleText = document.createElement('h2');
                subtitleText.innerText = config.subtitle;
                header.appendChild(subtitleText);
            }

            if (config.byline) {
                const bylineText = document.createElement('p');
                bylineText.innerText = config.byline;
                header.appendChild(bylineText);
            }

            if (header.innerText.length > 0) {
                header.classList.add(config.theme);
                header.setAttribute('id', 'header');
                story.appendChild(header);
            }

            config.chapters.forEach((record, idx) => {
                const container = document.createElement('div');
                const chapter = document.createElement('div');

                if (record.title) {
                    const title = document.createElement('h3');
                    title.innerText = record.title;
                    chapter.appendChild(title);
                }

                if (record.image) {
                    const image = new Image();
                    image.src = record.image;
                    chapter.appendChild(image);
                }

                if (record.description) {
                    const storyText = document.createElement('p');
                    storyText.innerHTML = record.description;
                    chapter.appendChild(storyText);
                }

                container.setAttribute('id', record.id);
                container.classList.add('step', 'chapter-box'); // Add chapter-box class
                if (idx === 0) {
                    container.classList.add('active');
                }

                chapter.classList.add(config.theme);
                container.appendChild(chapter);
                container.classList.add(alignments[record.alignment] || 'centered');  // Use the alignments object here
                if (record.hidden) {
                    container.classList.add('hidden');
                }
                features.appendChild(container);
            });

            story.appendChild(features);

            const footer = document.createElement('div');

            if (config.footer) {
                const footerText = document.createElement('p');
                footerText.innerHTML = config.footer;
                footerText.id = 'source-footer';
                footer.appendChild(footerText);
            }

            if (footer.innerText.length > 0) {
                footer.classList.add(config.theme);
                footer.setAttribute('id', 'footer');
                story.appendChild(footer);
            }

            const transformRequest = (url) => {
                const hasQuery = url.indexOf("?") !== -1;
                const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
                return {
                    url: url + suffix
                }
            }

            if (config.showMarkers) {
                const marker = new mapboxgl.Marker({ color: config.markerColor });
                marker.setLngLat(config.chapters[0].location.center).addTo(map);
            }

            const scroller = scrollama();

            map.on("load", function() {
                if (config.use3dTerrain) {
                    map.addSource('mapbox-dem', {
                        'type': 'raster-dem',
                        'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                        'tileSize': 512,
                        'maxzoom': 14
                    });
                    map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                    map.addLayer({
                        'id': 'sky',
                        'type': 'sky',
                        'paint': {
                            'sky-type': 'atmosphere',
                            'sky-atmosphere-sun': [0.0, 0.0],
                            'sky-atmosphere-sun-intensity': 15
                        }
                    });
                };

                scroller
                    .setup({
                        step: '.step',
                        offset: 0.5,
                        progress: true,
                        threshold: 0.5
                    })
                    .onStepEnter(response => {
                        const chapter = config.chapters.find(chap => chap.id === response.element.id);
                        response.element.classList.add('active');
                        map[chapter.mapAnimation || 'flyTo'](chapter.location);

                        if (chapter.onChapterEnter) {
                            chapter.onChapterEnter.forEach(function(layer) {
                                if (layer.layer && map.getLayer(layer.layer)) {
                                    map.setLayoutProperty(layer.layer, 'visibility', 'visible');
                                    map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
                                }
                            });
                        }

                        if (response.index === config.chapters.length - 1) {
                            document.getElementById('sidebar').classList.add('sidebar-visible');
                        }
                    })
                    .onStepExit(response => {
                        const chapter = config.chapters.find(chap => chap.id === response.element.id);
                        response.element.classList.remove('active');

                        if (chapter.onChapterExit) {
                            chapter.onChapterExit.forEach(function(layer) {
                                if (layer.layer && map.getLayer(layer.layer)) {
                                    map.setPaintProperty(layer.layer, 'fill-opacity', layer.opacity);
                                }
                            });
                        }

                        if (response.index === config.chapters.length - 1 && response.direction === 'down') {
                            document.getElementById('story').style.display = 'none';
                            document.getElementById('toggleStoryButton').innerText = 'Show Story';
                        }
                    });

                if (config.auto) {
                    document.querySelectorAll('[data-scrollama-index="0"]')[0].scrollIntoView();
                }
            });

            window.addEventListener('resize', scroller.resize);

            document.getElementById('toggleStoryButton').addEventListener('click', () => {
                const storyDiv = document.getElementById('story');
                const toggleButton = document.getElementById('toggleStoryButton');
                if (storyDiv.style.display === 'none') {
                    storyDiv.style.display = 'block';
                    toggleButton.innerText = 'Hide Story';
                } else {
                    storyDiv.style.display = 'none';
                    toggleButton.innerText = 'Show Story';
                }
            });
        });
    </script>
</body>
</html>

                   
